(function(a){a.removeDuplicate=function(a){if(a instanceof Array){var d=0;a:for(;d<a.length;d++)for(var c=0;c<a.length;c++)if(c!=d&&a[c]==a[d]){a=a.slice(c);continue a}return a}};a.extend(a.expr[":"],{inline:function(b){return a(b).is("a")||a(b).is("em")||a(b).is("i")||a(b).is("font")||a(b).is("span")||a(b).is("strong")||a(b).is("b")||a(b).is("u")}});var j=function(b,d){a.extend(this,{settings:d,createDOM:function(){this.textarea=b;this.container=document.createElement("div");this.iframe=document.createElement("iframe");
this.input=document.createElement("input");this.stylesheetLink=document.createElement("a");this.settings.stylesheet=a(this.stylesheetLink).attr({href:this.settings.stylesheet})[0].href;a(this.input).attr({type:"hidden",name:a(this.textarea).attr("name"),value:a(this.textarea).attr("value")});a(this.textarea).addClass("depageEditorTextarea");a(this.textarea).attr("name",a(this.textarea).attr("name")+"depageEditorTextarea");a(this.textarea).hide();a(this.container).addClass(d.containerClass);a(this.iframe).addClass("depageEditorIframe");
this.toolbar=new i(this);a(this.container).append(this.toolbar.itemsList);a(this.container).append(this.iframe);a(this.container).append(this.input);a(this.container).hide();this.input.depageEditorObject=this;a(this.textarea).replaceWith(this.container)},writeDocument:function(){var c='                    <html>                        <head>                            <link rel="stylesheet" type="text/css" href="'+d.stylesheet+'"></link>                        </head>                        <body id="iframeBody">                            '+
a(this.input).val()+"                        </body>                    </html>                ",c=c.replace(/INSERT:CONTENT:END/,a(this.input).val());this.iframe.contentWindow.document.open();this.iframe.contentWindow.document.write(c);this.iframe.contentWindow.document.close();var b=this;a(this.iframe).load(function(){b.autogrow()})},makeEditable:function(){var c=this;try{this.iframe.contentWindow.document.designMode="on"}catch(b){return setTimeout(function(){c.makeEditable()},250),!1}a(this.container).show();
a(this.textarea).show();a(this.iframe.contentWindow.document).mouseup(function(){c.toolbar.checkState(c);c.autogrow()}).keyup(function(){c.toolbar.checkState(c);c.autogrow()}).keydown(function(a){c.detectPaste(a);c.autogrow()}).scroll(function(){c.autogrow()});this.locked=!1},focusEditor:function(){a.browser.msie||this.iframe.focus()},styleWithCSS:function(){try{this.iframe.contentWindow.document.execCommand("styleWithCSS",!1,!1)}catch(a){try{this.iframe.contentWindow.document.execCommand("useCSS",
0,!0)}catch(b){}}},modifyFormSubmit:function(){var c=this;a(this.container).parents("form").submit(function(){return c.updateDepageEditorInput()})},insertNewParagraph:function(c){var b=a(this.iframe).contents().find("body"),d=this.iframe.contentWindow.document.createElement("p");a(c).each(function(){a(d).append(this)});b.append(d)},paragraphise:function(){if(d.insertParagraphs&&this.wysiwyg){var c=a(this.iframe).contents().find("body").contents();c.each(function(){"#text"==this.nodeName.toLowerCase()&&
-1!=this.data.search(/^\s*$/)&&(this.data="")});var b=this,f=[];c.each(function(){if(a(this).is(":inline")||3==this.nodeType)f.push(this),a(this).remove();else if(a(this).is("br")){if(!a(this).is(":last-child"))if(a(this).next().is("br")){for(;a(this).next().is("br");)a(this).remove();f.length&&(b.insertNewParagraph(f,this),f=[])}else(a(this).is(":inline")||3==this.nodeType)&&f.length&&f.push(this.cloneNode(!0)),a(this).remove()}else f.length&&(b.insertNewParagraph(f,this),f=[])});0<f.length&&this.insertNewParagraph(f)}},
switchMode:function(){this.locked||(this.locked=!0,this.wysiwyg?(this.updateDepageEditorInput(),a(this.textarea).val(a(this.input).val()),a(this.iframe).replaceWith(this.textarea),this.toolbar.disable(),this.locked=this.wysiwyg=!1):(this.updateDepageEditorInput(),a(this.textarea).replaceWith(this.iframe),this.writeDocument(this.input.value),this.toolbar.enable(),this.makeEditable(),this.wysiwyg=!0))},detectPaste:function(c){if(c.ctrlKey&&86==c.keyCode&&!this.cleaning){var b=this;setTimeout(function(){b.cleanSource()},
100)}if(13==c.keyCode){for(c=this.getSelection().parentnode;3==c[0].nodeType||c.is(":inline");)c=c.parent();c=c[0].nodeName.toLowerCase();if("body"==c||"div"==c)c=a.browser.msie?"<p>":"p",this.styleWithCSS(),this.iframe.contentWindow.document.execCommand("FormatBlock",!1,c)}},cleanSource:function(){this.cleaning=!0;var c="",c=a(this.iframe.contentWindow.document).find("body");c.find("*").each(function(){var c=this.nodeName.toLowerCase();if(-1===a.inArray(c,d.allowedTags))if("remove"==d.undesiredTags[c])a(this).remove();
else{var b=a(this);if("body"==b.parent()[0].tagName.toLowerCase()&&this.firstChild&&(a(this.firstChild).is(":inline")||3==this.firstChild.nodeType)){var g=a("<p></p>").insertBefore(b);b.contents().each(function(){g.append(this)})}else b.contents().each(function(){b.before(this)});b.remove()}});c=this.wysiwyg?c.html():a(this.textarea).val();c=c.replace(/^\s*/,"");c=c.replace(/\s*$/,"");c=c.replace(/<--.*--\>/,"");c=c.replace(/<[^>]*>/g,function(c){c=c.replace(/='(.*)' /g,'="$1" ');c=c.replace(/ ([^=]+)="?([^"]*)"?/g,
function(c,b,e){if(-1==a.inArray(b,d.allowedAttributes))return"";switch(b){case "id":if(-1==a.inArray(e,d.allowedIDs))return"";case "class":if(-1==a.inArray(e,d.allowedClasses))return"";default:return c}});return c.toLowerCase()});c=c.replace(/ style="[^"]*"/g,"");c=c.replace(/<br>/g,"<br />");c=c.replace(/<br \/>\s*<\/(h1|h2|h3|h4|h5|h6|li|p)/g,"</$1");c=c.replace(/(<br \/>)*\s*(<\/[^>]*>)/g,"$2$1");c=c.replace(/(<img [^>]+[^\/])>/g,"$1 />");c=c.replace(/(<[^\/]>|<[^\/][^>]*[^\/]>)\s*<\/[^>]*>/g,
"");c=c.replace(/<\?xml[^>]*>/g,"");c=c.replace(/<[^ >]+:[^>]*>/g,"");c=c.replace(/<\/[^ >]+:[^>]*>/g,"");c=c.replace(/\n/g,"");c=c.replace(/(<\/(p|h1|h2|li|ul|ol)>)/g,"$1\n");this.wysiwyg?a(this.iframe.contentWindow.document).find("body").html(c):a(this.textarea).val(c);a(this.input).val(c);this.cleaning=!1},refreshDisplay:function(){this.wysiwyg?a(this.iframe.contentWindow.document).find("body").html(a(this.input).val()):a(this.textarea).val(a(this.input).val())},autogrow:function(){if(!1!=this.settings.autogrow&&
this.wysiwyg){var c=a(this.iframe.contentWindow.document.body),b=a(this.toolbar.itemsList),d=0;void 0!=c[0]&&(d=Math.max(0,a(window).scrollTop()-a(this.iframe).offset().top),d=Math.min(d,a(this.iframe).height()-b.height()),b.css({top:d}),d=c.children(":last"),d=0<d.length?d.offset().top+d.height()+30-a(window).scrollTop():c.offsetHeight+30,d=Math.max(d,b.height()),c.css({overflow:"hidden",scroll:"no"}),a(this.iframe).height(d),a(this.textarea).height(d))}},updateDepageEditorInput:function(){this.wysiwyg?
(this.paragraphise(),this.cleanSource()):a(this.input).val(a(this.textarea).val())},getSelection:function(){var c=null,b=null,d=null;if(this.iframe.contentWindow.document.selection){c=this.iframe.contentWindow.document.selection;b=c.createRange();try{d=a(b.parentElement())}catch(g){return!1}}else{try{c=this.iframe.contentWindow.getSelection()}catch(h){return!1}b=c.getRangeAt(0);d=a(b.commonAncestorContainer)}return{range:b,parentnode:d}},init:function(){var c=this;"string"!=typeof document.designMode&&
"off"!=document.designMode||(c.locked=!0,c.cleaning=!1,c.DOMCache="",c.wysiwyg=!0,c.createDOM(),c.writeDocument(),c.makeEditable(),c.modifyFormSubmit(),c.autogrow(),a(window).scroll(function(){c.autogrow()}))}});this.init()},i=function(b){a.extend(this,{createDOM:function(){var b=this;this.itemsList=document.createElement("ul");a(this.itemsList).addClass("depageEditorToolbar");a.each(this.depageEditor.settings.toolbarItems,function(a,e){"formatblock"==e?b.addSelect(e):b.addButton(e)})},addButton:function(b){var c=
a.depageEditorToolbarItems[b],e=a(document.createElement("li")),b="undefined"!=typeof this.depageEditor.settings.translation[b]?this.depageEditor.settings.translation[b]:c.label,f=a(document.createElement("a")).attr({title:b,"class":c.className,href:"#"+b}).click(function(){return!1});c.editor=this.depageEditor;a(f).data("action",c);a(f).data("editor",this.depageEditor);f.bind("click",c.action);f.append(document.createTextNode(b));e.append(f);a(this.itemsList).append(e)},addSelect:function(b){var c=
this,e=a.depageEditorToolbarItems[b],f=a(document.createElement("li")).attr("class","depageEditorEditSelect"),g=a(document.createElement("select")).attr({name:e.name,"class":e.className});a(g).data("editor",this.depageEditor);a(g).change(e.action);var h=a(document.createElement("option"));h.append(document.createTextNode("undefined"!=typeof this.depageEditor.settings.translation[b]?this.depageEditor.settings.translation[b]:e.label));g.append(h);a.each(this.depageEditor.settings.selectBlockOptions,
function(b,d){var e=a(document.createElement("option")).attr("value",d);e.append(document.createTextNode(c.depageEditor.settings.translation[d]));g.append(e)});f.append(g);a(this.itemsList).append(f)},disable:function(){a(this.itemsList).toggleClass("depageEditorSource");a(this.itemsList).find("li select").attr("disabled","disabled")},enable:function(){a(this.itemsList).toggleClass("depageEditorSource");a(this.itemsList).find("select").removeAttr("disabled")},checkState:function(b,c){if(!c)return setTimeout(function(){b.toolbar.checkState(b,
!0);return!0},200),!0;a(b.toolbar.itemsList).find("a").removeClass("on");for(var e=b.getSelection().parentnode;3==e[0].nodeType;)e=e.parent();for(;!e.is("body");)e.is("a")?b.toolbar.setState("link","on"):e.is("em")||e.is("i")?b.toolbar.setState("italic","on"):e.is("strong")||e.is("b")?b.toolbar.setState("bold","on"):e.is("span")||e.is("p")?("italic"==e.css("font-style")&&b.toolbar.setState("italic","on"),"bold"==e.css("font-weight")&&b.toolbar.setState("bold","on")):e.is("ol")?(b.toolbar.setState("orderedlist",
"on"),b.toolbar.setState("unorderedlist","off")):e.is("ul")?(b.toolbar.setState("orderedlist","on"),b.toolbar.setState("unorderedlist","off")):b.toolbar.setState("formatblock",e[0].nodeName.toLowerCase()),e=e.parent()},setState:function(b,c){"SelectBlock"!=b?a(this.itemsList).find("."+a.depageEditorToolbarItems[b].className).addClass("on"):a(this.itemsList).find("."+a.depageEditorToolbarItems[b].className).val(c)},init:function(a){this.depageEditor=a;this.createDOM()}});this.init(b)};a.depageEditorToolbarItems=
new function(){depageEditorToolbarItemsClass=this.constructor;if("undefined"!=typeof depageEditorToolbarItemsClass.singleton)return depageEditorToolbarItemsClass.singleton;depageEditorToolbarItemsClass.singleton=this;a.extend(depageEditorToolbarItemsClass.singleton,{bold:{className:"depageEditorButtonBold",action:function(){var b=a.data(this,"editor");b.wysiwyg&&(b.styleWithCSS(),b.iframe.contentWindow.document.execCommand("bold",!1,null),b.toolbar.setState("bold","on"),b.focusEditor())}},italic:{className:"depageEditorButtonItalic",
action:function(){var b=a.data(this,"editor");b.wysiwyg&&(b.styleWithCSS(),b.iframe.contentWindow.document.execCommand("italic",!1,null),b.toolbar.setState("italic","on"),b.focusEditor())}},link:{className:"depageEditorButtonHyperlink",action:function(){var b=a.data(this,"editor");if(b.wysiwyg)if(a(this).hasClass("on"))b.styleWithCSS(),b.iframe.contentWindow.document.execCommand("Unlink",!1,null),b.focusEditor();else if(""==a(b.iframe).getSelection())alert(b.settings.translation.selectTextToHyperlink),
b.focusEditor();else{var d=prompt(b.settings.translation.linkURL,"http://");null!=d&&(b.styleWithCSS(),b.iframe.contentWindow.document.execCommand("CreateLink",!1,d),b.toolbar.setState("link","on"),b.focusEditor())}}},orderedlist:{className:"depageEditorButtonOrderedList",action:function(){var b=a.data(this,"editor");b.wysiwyg&&(b.styleWithCSS(),b.iframe.contentWindow.document.execCommand("insertorderedlist",!1,null),b.toolbar.setState("orderedlist","on"),b.focusEditor())}},unorderedlist:{className:"depageEditorButtonUnorderedList",
action:function(){var b=a.data(this,"editor");b.wysiwyg&&(b.styleWithCSS(),b.iframe.contentWindow.document.execCommand("insertunorderedlist",!1,null),b.toolbar.setState("unorderedlist","on"),b.focusEditor())}},image:{className:"depageEditorButtonImage",action:function(){var b=a.data(this,"editor");if(b.wysiwyg){var d=prompt(b.settings.translation.imageLocation,"");if(null!=d&&""!=d){var c=prompt(b.settings.translation.imageAlternateText,""),c=c.replace(/"/g,"'");a(b.iframe).appendToSelection("img",
{src:d,alt:c},null,!0)}b.focusEditor()}}},htmlsource:{className:"depageEditorButtonHTML",action:function(){a.data(this,"editor").switchMode()}},formatblock:{className:"depageEditorSelectformatblock",action:function(){var b=a.data(this,"editor");if(b.wysiwyg){var d=a.browser.msie?"<"+a(this).val()+">":a(this).val();b.styleWithCSS();b.iframe.contentWindow.document.execCommand("FormatBlock",!1,d);b.focusEditor()}}}})};a.fn.extend({getSelection:function(){if(this.is("iframe"))return iframe=this[0],iframe.contentWindow.document.selection?
iframe.contentWindow.document.selection.createRange().text:iframe.contentWindow.getSelection().toString()},appendToSelection:function(b,d,c,e){if(this.is("iframe"))if(iframe=this[0],a.browser.msie){var f;f="<"+b;a.each(d,function(a,b){f+=" "+a+'="'+b+'"'});e?f+=" />":(f+=">",c&&"undefined"!=typeof c&&(f+=c),f+="</"+b+">");e=iframe.contentWindow.document.selection;e=e.createRange();a(e.parentElement()).parents("body").is("#iframeBody ")||(e.collapse(!1),e.pasteHTML(f))}else e=iframe.contentWindow.getSelection(),
e=e.getRangeAt(0),e.collapse(!1),b=iframe.contentWindow.document.createElement(b),a(b).attr(d),c&&"undefined"!=typeof c&&a(b).append(document.createTextNode(c)),e.insertNode(b)},depageEditor:function(b){for(var d={script:"remove",meta:"remove",link:"remove",basefont:"remove",object:"remove",applet:"remove",input:"remove",select:"remove",textarea:"remove",button:"remove",isindex:"remove",area:"remove",frame:"remove",frameset:"remove",noframes:"remove",iframe:"remove"},c="class id href title alt src".split(" "),
b=a.extend({insertParagraphs:!0,stylesheet:"depageEditorContent.css",toolbarItems:"bold italic link orderedlist unorderedlist htmlsource formatblock".split(" "),selectBlockOptions:"h1 h2 h3 h4 h5 h6 p".split(" "),undesiredTags:d,allowedTags:"p h1 h2 ul ol li a b strong i em".split(" "),allowedClasses:[],allowedIDs:[],allowedAttributes:c,containerClass:"depageEditor",translation:{bold:"Bold",italic:"Italic",link:"Hyperlink",unorderedlist:"Unordered List",orderedlist:"Ordered List",image:"Insert image",
htmlsource:"HTML Source",formatblock:"Change Block Type",h1:"Heading 1",h2:"Heading 2",h3:"Heading 3",h4:"Heading 4",h5:"Heading 5",h6:"Heading 6",p:"Paragraph",selectTextToHyperlink:"Please select the text you wish to hyperlink.",linkURL:"Enter the URL for this link:",imageLocation:"Enter the location for this image:",imageAlternateText:"Enter the alternate text for this image:"},autogrow:!1},b),e=b.selectBlockOptions.length-1;0<=e;e--)-1===a.inArray(b.selectBlockOptions[e],b.allowedTags)&&b.selectBlockOptions.splice(e,
1);b.undesiredTags=b.undesiredTags.length!=d.length?a.removeDuplicate(a.merge(b.undesiredTags,d)):b.undesiredTags;b.allowedAttributes=b.allowedAttributes.length!=c.length?a.removeDuplicate(a.merge(b.allowedAttributes,c)):b.allowedAttributes;return this.each(function(){new j(this,b)})}})})(jQuery);
